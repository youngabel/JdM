<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globo Interattivo delle Nazioni</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: #050510; /* Sfondo scuro, quasi nero */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }
        #main-container {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #main-container:grabbing {
            cursor: grabbing;
        }
        .ui-panel {
            position: absolute;
            padding: 12px 18px;
            background-color: rgba(10, 20, 35, 0.85);
            border: 1px solid rgba(127, 178, 255, 0.4);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(5px);
        }
        #country-info {
            top: 20px;
            left: 20px;
            display: none; /* Nascosto di default */
            min-width: 200px;
        }
        #country-info h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #7fbbff;
        }
        #map-2d-container {
            bottom: 20px;
            left: 20px;
            width: 300px;
            height: 180px;
            padding: 10px;
        }
        #map-2d-container svg {
            width: 100%;
            height: 100%;
        }
        #capital-tabs {
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #capital-tabs button {
            background-color: rgba(40, 60, 90, 0.8);
            color: #eee;
            border: 1px solid #4a6a9c;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-family: inherit;
        }
        #capital-tabs button:hover {
            background-color: rgba(80, 110, 160, 0.9);
            transform: scale(1.05);
        }
        #zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #zoom-controls button {
            width: 40px;
            height: 40px;
            font-size: 24px;
            font-weight: bold;
            background-color: rgba(40, 40, 40, 0.8);
            color: #fff;
            border: 1px solid #666;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #zoom-controls button:hover {
            background-color: rgba(80, 80, 80, 0.9);
        }
        
    </style>
</head>
<body>
    <div id="main-container"></div>

    <div id="country-info" class="ui-panel">
        <div class="info-header">
            <h2 id="country-name"></h2>
        </div>
        <p id="capital-name"></p>
        <p id="country-population"></p>
        <a id="wiki-link" href="#" target="_blank">Approfondisci su Wikipedia</a>
    </div>

    <div id="map-2d-container" class="ui-panel">
        <svg id="map-2d"></svg>
    </div>

    <div id="capital-tabs"></div>

    <div id="zoom-controls">
        <button id="zoom-in">+</button>
        <button id="zoom-out">-</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Costanti e Variabili Globali ---
        const GLOBE_RADIUS = 1.0;
        const container = document.getElementById('main-container');

        let scene, camera, renderer, globe;
        let routeStartCapital = null; // Memorizza la capitale di partenza per la rotta
        let routeLine = null;         // Riferimento alla linea 3D della rotta, per poterla rimuovere
        let raycaster, mouse = new THREE.Vector2();
        
        const countryObjects = [];
        let selectedCountry = null;
        let threeFont;

        let cameraTargetPos = new THREE.Vector3();
        let isCameraMoving = false;

        // --- ELENCO DELLE CAPITALI (facilmente espandibile) ---
        const capitals = [
            { name: 'Roma', country: 'Italy', lat: 41.9028, lon: 12.4964, population: 2.87e6 },
            { name: 'Parigi', country: 'France', lat: 48.8566, lon: 2.3522, population: 2.14e6 },
            { name: 'Tokyo', country: 'Japan', lat: 35.6762, lon: 139.6503, population: 13.96e6 },
                          { name: 'Londra', country: 'United Kingdom', lat: 51.5074, lon: -0.1278, population: 8982000 },
                          { name: 'Pechino', country: 'China', lat: 39.9042, lon: 116.4074, population: 21540000 },
                          { name: 'Mosca', country: 'Russia', lat: 55.7558, lon: 37.6173, population: 12500000 },
                          { name: 'Il Cairo', country: 'Egypt', lat: 30.0444, lon: 31.2357, population: 9845000 },
                          { name: 'Brasilia', country: 'Brazil', lat: -15.8267, lon: -47.9218, population: 3055000 },
                          { name: 'Canberra', country: 'Australia', lat: -35.2809, lon: 149.1300, population: 426704 },
                          { name: 'Nuova Delhi', country: 'India', lat: 28.6139, lon: 77.2090, population: 142000000 },
                          { name: 'Ottawa', country: 'Canada', lat: 45.4215, lon: -75.6972, population: 994837 },
                          { name: 'Buenos Aires', country: 'Argentina', lat: -34.6037, lon: -58.3816, population: 2891000 },
                          { name: 'Washington D.C.', country: 'United States of America', lat: 38.9072, lon: -77.0369, population: 705749 },{ name: 'Madrid', country: 'Spain', lat: 40.4168, lon: -3.7038, population: 3223000 },
                          { name: 'Berlino', country: 'Germany', lat: 52.5200, lon: 13.4050, population: 3645000 },
                          { name: 'Kiev', country: 'Ukraine', lat: 50.4501, lon: 30.5234, population: 2962000 },
                          { name: 'Stoccolma', country: 'Sweden', lat: 59.3293, lon: 18.0686, population: 975551 },
                          { name: 'Atene', country: 'Greece', lat: 37.9838, lon: 23.7275, population: 664046 },
                          { name: 'Ankara', country: 'Turkey', lat: 39.9334, lon: 32.8663, population: 5150000 },
                          { name: 'Seul', country: 'South Korea', lat: 37.5665, lon: 126.9780, population: 9776000 },
                          { name: 'Bangkok', country: 'Thailand', lat: 13.7563, lon: 100.5018, population: 10539000 },
                          { name: 'Città del Messico', country: 'Mexico', lat: 19.4326, lon: -99.1332, population: 9209000 },
                          { name: 'Lima', country: 'Peru', lat: -12.0464, lon: -77.0428, population: 9674000 },
                          { name: 'Bogotà', country: 'Colombia', lat: 4.7110, lon: -74.0721, population: 7743000 },
                          { name: 'Santiago', country: 'Chile', lat: -33.4489, lon: -70.6693, population: 6158000 },
                          { name: 'Pretoria', country: 'South Africa', lat: -25.7479, lon: 28.2293, population: 741651 },
                          { name: 'Nairobi', country: 'Kenya', lat: -1.2921, lon: 36.8219, population: 4397000 },
                          { name: 'Abuja', country: 'Nigeria', lat: 9.0765, lon: 7.3986, population: 1078000 },
                          { name: 'Giacarta', country: 'Indonesia', lat: -6.2088, lon: 106.8456, population: 10562000 },
                          { name: 'Wellington', country: 'New Zealand', lat: -41.2865, lon: 174.7762, population: 212700 },
                          { name: 'Oslo', country: 'Norway', lat: 59.9139, lon: 10.7522, population: 697549 },
                          { name: 'Varsavia', country: 'Poland', lat: 52.2297, lon: 21.0122, population: 1794000 },
                          { name: 'Lisbona', country: 'Portugal', lat: 38.7223, lon: -9.1393, population: 504718 },{ name: 'Amsterdam', country: 'Netherlands', lat: 52.3676, lon: 4.9041, population: 821752 },
                          { name: 'Bruxelles', country: 'Belgium', lat: 50.8503, lon: 4.3517, population: 1209000 },
                          { name: 'Vienna', country: 'Austria', lat: 48.2082, lon: 16.3738, population: 1897000 },
                          { name: 'Praga', country: 'Czechia', lat: 50.0755, lon: 14.4378, population: 1324000 },
                          { name: 'Budapest', country: 'Hungary', lat: 47.4979, lon: 19.0402, population: 1752000 },
                          { name: 'Bucarest', country: 'Romania', lat: 44.4268, lon: 26.1025, population: 1883000 },
                          { name: 'Copenaghen', country: 'Denmark', lat: 55.6761, lon: 12.5683, population: 632340 },
                          { name: 'Helsinki', country: 'Finland', lat: 60.1699, lon: 24.9384, population: 650058 },
                          { name: 'Dublino', country: 'Ireland', lat: 53.3498, lon: -6.2603, population: 544107 },
                          { name: 'Riyadh', country: 'Saudi Arabia', lat: 24.7136, lon: 46.6753, population: 7676000 },
                          { name: 'Tehran', country: 'Iran', lat: 35.6892, lon: 51.3890, population: 8693000 },
                          { name: 'Baghdad', country: 'Iraq', lat: 33.3152, lon: 44.3661, population: 8126000 },
                          { name: 'Damasco', country: 'Syria', lat: 33.5138, lon: 36.2765, population: 1711000 },
                          { name: 'Kuala Lumpur', country: 'Malaysia', lat: 3.1390, lon: 101.6869, population: 1800000 },
                          { name: 'Singapore', country: 'Singapore', lat: 1.3521, lon: 103.8198, population: 5638000 },
                          { name: 'Manila', country: 'Philippines', lat: 14.5995, lon: 120.9842, population: 1780000 },
                          { name: 'Hanoi', country: 'Vietnam', lat: 21.0278, lon: 105.8342, population: 8053000 },
                          { name: 'Caracas', country: 'Venezuela', lat: 10.4806, lon: -66.9036, population: 1943000 },
                          { name: 'L\'Avana', country: 'Cuba', lat: 23.1136, lon: -82.3666, population: 2130000 },
                          { name: 'Kingston', country: 'Jamaica', lat: 17.9836, lon: -76.8037, population: 668869 },
                          { name: 'Panama', country: 'Panama', lat: 8.9833, lon: -79.5167, population: 880691 },
                          { name: 'Quito', country: 'Ecuador', lat: -0.1807, lon: -78.4678, population: 1890000 },
                          { name: 'Montevideo', country: 'Uruguay', lat: -34.9011, lon: -56.1645, population: 1319000 },
                          { name: 'Asunción', country: 'Paraguay', lat: -25.2637, lon: -57.5759, population: 525294 },
                          { name: 'Rabat', country: 'Morocco', lat: 34.0209, lon: -6.8417, population: 577827 },
                          { name: 'Algeri', country: 'Algeria', lat: 36.7754, lon: 3.0588, population: 3415000 },
                          { name: 'Tunisi', country: 'Tunisia', lat: 36.8065, lon: 10.1815, population: 1056000 },
                          { name: 'Dakar', country: 'Senegal', lat: 14.7167, lon: -17.4677, population: 1146000 },
                          { name: 'Accra', country: 'Ghana', lat: 5.6037, lon: -0.1870, population: 2291000 },
                          { name: 'Luanda', country: 'Angola', lat: -8.8399, lon: 13.2894, population: 8330000 },{ name: 'Kabul', country: 'Afghanistan', lat: 34.5553, lon: 69.2075, population: 4222000 },
                          { name: 'Tirana', country: 'Albania', lat: 41.3275, lon: 19.8187, population: 418495 },
                          { name: 'Erevan', country: 'Armenia', lat: 40.1792, lon: 44.4991, population: 1093485 },
                          { name: 'Baku', country: 'Azerbaijan', lat: 40.4093, lon: 49.8671, population: 2293000 },
                          { name: 'Minsk', country: 'Belarus', lat: 53.9045, lon: 27.5615, population: 2020600 },
                          { name: 'Sarajevo', country: 'Bosnia and Herzegovina', lat: 43.8563, lon: 18.4131, population: 275524 },
                          { name: 'Sofia', country: 'Bulgaria', lat: 42.6977, lon: 23.3219, population: 1242568 },
                          { name: 'Zagabria', country: 'Croatia', lat: 45.8150, lon: 15.9819, population: 806341 },
                          { name: 'Nicosia', country: 'Cyprus', lat: 35.1856, lon: 33.3823, population: 116312 },
                          { name: 'Tallinn', country: 'Estonia', lat: 59.4370, lon: 24.7536, population: 437619 },
                          { name: 'Tbilisi', country: 'Georgia', lat: 41.7151, lon: 44.8271, population: 1118035 },
                          { name: 'Reykjavík', country: 'Iceland', lat: 64.1466, lon: -21.9426, population: 131345 },
                          { name: 'Astana', country: 'Kazakhstan', lat: 51.1694, lon: 71.4491, population: 1136008 },
                          { name: 'Pristina', country: 'Kosovo', lat: 42.6629, lon: 21.1655, population: 198897 },
                          { name: 'Riga', country: 'Latvia', lat: 56.9496, lon: 24.1052, population: 632614 },
                          { name: 'Vilnius', country: 'Lithuania', lat: 54.6872, lon: 25.2797, population: 580020 },
                          { name: 'Lussemburgo', country: 'Luxembourg', lat: 49.6116, lon: 6.1319, population: 122273 },
                          { name: 'La Valletta', country: 'Malta', lat: 35.8989, lon: 14.5146, population: 6444 },
                          { name: 'Chișinău', country: 'Moldova', lat: 47.0105, lon: 28.8638, population: 532513 },
                          { name: 'Podgorica', country: 'Montenegro', lat: 42.4304, lon: 19.2594, population: 150977 },
                          { name: 'Skopje', country: 'North Macedonia', lat: 41.9981, lon: 21.4254, population: 506926 },
                          { name: 'Belgrado', country: 'Serbia', lat: 44.7866, lon: 20.4489, population: 1166763 },
                          { name: 'Bratislava', country: 'Slovakia', lat: 48.1486, lon: 17.1077, population: 437726 },
                          { name: 'Lubiana', country: 'Slovenia', lat: 46.0569, lon: 14.5058, population: 295504 },
                          { name: 'Berna', country: 'Switzerland', lat: 46.9480, lon: 7.4474, population: 133883 },
                          { name: 'Tashkent', country: 'Uzbekistan', lat: 41.2995, lon: 69.2401, population: 2571000 },
                          { name: 'Phnom Penh', country: 'Cambodia', lat: 11.5564, lon: 104.9282, population: 2129371 },
                          { name: 'Dacca', country: 'Bangladesh', lat: 23.8103, lon: 90.4125, population: 21005860 },
                          { name: 'Thimphu', country: 'Bhutan', lat: 27.4712, lon: 89.6339, population: 114551 },
                          { name: 'Katmandu', country: 'Nepal', lat: 27.7172, lon: 85.3240, population: 1442271 },
                          { name: 'Islamabad', country: 'Pakistan', lat: 33.6844, lon: 73.0479, population: 1014825 },
                          { name: 'Colombo', country: 'Sri Lanka', lat: 6.9271, lon: 79.8612, population: 752993 },
                          { name: 'Addis Abeba', country: 'Ethiopia', lat: 9.0300, lon: 38.7400, population: 3384569 },
                          { name: 'Khartoum', country: 'Sudan', lat: 15.5007, lon: 32.5599, population: 5274000 },
                          { name: 'Kampala', country: 'Uganda', lat: 0.3476, lon: 32.5825, population: 1680800 },
                          { name: 'Dar es Salaam', country: 'Tanzania', lat: -6.7924, lon: 39.2083, population: 6400000 },
                          { name: 'Harare', country: 'Zimbabwe', lat: -17.8252, lon: 31.0335, population: 2150000 },
                          { name: 'Maputo', country: 'Mozambique', lat: -25.9692, lon: 32.5732, population: 1088000 },
                          { name: 'Windhoek', country: 'Namibia', lat: -22.5609, lon: 17.0836, population: 431000 },
                          { name: 'Gaborone', country: 'Botswana', lat: -24.6282, lon: 25.9231, population: 231626 },
                          { name: 'Lusaka', country: 'Zambia', lat: -15.3875, lon: 28.3228, population: 1747152 },
                          { name: 'Libreville', country: 'Gabon', lat: 0.4162, lon: 9.4673, population: 703904 },
                          { name: 'Yaoundé', country: 'Cameroon', lat: 3.8480, lon: 11.5021, population: 2765000 },
                          { name: 'Kinshasa', country: 'Democratic Republic of the Congo', lat: -4.4419, lon: 15.2663, population: 14970000 },
                          { name: 'Brazzaville', country: 'Republic of the Congo', lat: -4.2634, lon: 15.2429, population: 2393000 },{ name: 'Ulan Bator', country: 'Mongolia', lat: 47.9187, lon: 106.9170, population: 1539000 },
                          { name: 'Pyongyang', country: 'North Korea', lat: 39.0392, lon: 125.7625, population: 2881000 },
                          { name: 'Taipei', country: 'Taiwan', lat: 25.0330, lon: 121.5654, population: 2646000 },
                          { name: 'Doha', country: 'Qatar', lat: 25.2854, lon: 51.5310, population: 2382000 },
                          { name: 'Abu Dhabi', country: 'United Arab Emirates', lat: 24.4539, lon: 54.3773, population: 1483000 },
                          { name: 'Mascate', country: 'Oman', lat: 23.5889, lon: 58.3842, population: 1421000 },
                          { name: 'Sana\'a', country: 'Yemen', lat: 15.3694, lon: 44.1910, population: 3937000 },
                          { name: 'Amman', country: 'Jordan', lat: 31.9454, lon: 35.9284, population: 4061000 },
                          { name: 'Beirut', country: 'Lebanon', lat: 33.8938, lon: 35.5018, population: 2200000 },
                          { name: 'Manama', country: 'Bahrain', lat: 26.2285, lon: 50.5860, population: 200000 },
                          { name: 'Kuwait City', country: 'Kuwait', lat: 29.3759, lon: 47.9774, population: 3000000 },
                          { name: 'Male', country: 'Maldives', lat: 4.1755, lon: 73.5093, population: 133412 },
                          { name: 'Naypyidaw', country: 'Myanmar', lat: 19.7633, lon: 96.0785, population: 924608 },
                          { name: 'Vientiane', country: 'Laos', lat: 17.9748, lon: 102.6309, population: 948476 },
                          { name: 'Bridgetown', country: 'Barbados', lat: 13.1057, lon: -59.6132, population: 110000 },
                          { name: 'Port of Spain', country: 'Trinidad and Tobago', lat: 10.6552, lon: -61.5140, population: 37074 },
                          { name: 'Georgetown', country: 'Guyana', lat: 6.8013, lon: -58.1551, population: 118363 },
                          { name: 'Paramaribo', country: 'Suriname', lat: 5.8520, lon: -55.2038, population: 240924 },
                          { name: 'Asmara', country: 'Eritrea', lat: 15.3229, lon: 38.9251, population: 963000 },
                          { name: 'Gibuti', country: 'Djibouti', lat: 11.5890, lon: 43.1450, population: 775000 },
                          { name: 'Mogadiscio', country: 'Somalia', lat: 2.0469, lon: 45.3182, population: 2388000 },
                          { name: 'Antananarivo', country: 'Madagascar', lat: -18.8792, lon: 47.5079, population: 1275000 },
                          { name: 'Port Louis', country: 'Mauritius', lat: -20.1609, lon: 57.5012, population: 147095 },
                          { name: 'Moroni', country: 'Comoros', lat: -11.7022, lon: 43.2541, population: 62351 },
                          { name: 'Victoria', country: 'Seychelles', lat: -4.6191, lon: 55.4513, population: 26450 },
                          { name: 'Banjul', country: 'Gambia', lat: 13.4549, lon: -16.5790, population: 31301 },
                          { name: 'Bissau', country: 'Guinea-Bissau', lat: 11.8636, lon: -15.5977, population: 492004 },
                          { name: 'Conakry', country: 'Guinea', lat: 9.5370, lon: -13.6775, population: 1667864 },
                          { name: 'Freetown', country: 'Sierra Leone', lat: 8.4844, lon: -13.2299, population: 1055964 },
                          { name: 'Monrovia', country: 'Liberia', lat: 6.3155, lon: -10.8047, population: 1021762 },
                          { name: 'Yamoussoukro', country: 'Ivory Coast', lat: 6.8206, lon: -5.2768, population: 355573 },
                          { name: 'Bamako', country: 'Mali', lat: 12.6392, lon: -8.0029, population: 2710000 },
                          { name: 'Ouagadougou', country: 'Burkina Faso', lat: 12.3714, lon: -1.5197, population: 2453496 },
                          { name: 'Niamey', country: 'Niger', lat: 13.5116, lon: 2.1254, population: 1292000 },
                          { name: 'N\'Djamena', country: 'Chad', lat: 12.1348, lon: 15.0557, population: 1092066 },
                          { name: 'Bangui', country: 'Central African Republic', lat: 4.3947, lon: 18.5582, population: 889231 },
                          { name: 'Malabo', country: 'Equatorial Guinea', lat: 3.7523, lon: 8.7741, population: 297000 },
                          { name: 'São Tomé', country: 'Sao Tome and Principe', lat: 0.3365, lon: 6.7273, population: 71868 },
                          { name: 'Kigali', country: 'Rwanda', lat: -1.9441, lon: 30.0619, population: 1132000 },
                          { name: 'Bujumbura', country: 'Burundi', lat: -3.3822, lon: 29.3644, population: 1100000 },{ name: 'Lilongwe', country: 'Malawi', lat: -13.9626, lon: 33.7741, population: 989318 },
                          { name: 'Praia', country: 'Cape Verde', lat: 14.9330, lon: -23.5133, population: 159050 },
                          { name: 'Tegucigalpa', country: 'Honduras', lat: 14.0723, lon: -87.1921, population: 1157509 },
                          { name: 'Managua', country: 'Nicaragua', lat: 12.1150, lon: -86.2362, population: 1055247 },
                          { name: 'San José', country: 'Costa Rica', lat: 9.9281, lon: -84.0907, population: 333980 },
                          { name: 'San Salvador', country: 'El Salvador', lat: 13.7942, lon: -89.1872, population: 567698 },
                          { name: 'Città del Guatemala', country: 'Guatemala', lat: 14.6349, lon: -90.5069, population: 994938 },
                          { name: 'Belmopan', country: 'Belize', lat: 17.2510, lon: -88.7590, population: 16451 },
                          { name: 'Nassau', country: 'Bahamas', lat: 25.0479, lon: -77.3554, population: 274400 },
                          { name: 'Port-au-Prince', country: 'Haiti', lat: 18.5944, lon: -72.3074, population: 987310 },
                          { name: 'Santo Domingo', country: 'Dominican Republic', lat: 18.4861, lon: -69.9312, population: 1128000 },
                          { name: 'Saint John\'s', country: 'Antigua and Barbuda', lat: 17.1274, lon: -61.8447, population: 22219 },
                          { name: 'Basseterre', country: 'Saint Kitts and Nevis', lat: 17.2974, lon: -62.7233, population: 14000 },
                          { name: 'Castries', country: 'Saint Lucia', lat: 14.0103, lon: -60.9880, population: 70000 },
                          { name: 'Kingstown', country: 'Saint Vincent and the Grenadines', lat: 13.1565, lon: -61.2248, population: 16500 },
                          { name: 'Saint George\'s', country: 'Grenada', lat: 12.0569, lon: -61.7516, population: 33734 },
                          { name: 'Roseau', country: 'Dominica', lat: 15.3013, lon: -61.3863, population: 14725 },
                          { name: 'Apia', country: 'Samoa', lat: -13.8333, lon: -171.7667, population: 37391 },
                          { name: 'Nuku\'alofa', country: 'Tonga', lat: -21.1393, lon: -175.2048, population: 23221 },
                          { name: 'Suva', country: 'Fiji', lat: -18.1416, lon: 178.4419, population: 88271 },
                          { name: 'Port Vila', country: 'Vanuatu', lat: -17.7333, lon: 168.3167, population: 44039 },
                          { name: 'Honiara', country: 'Solomon Islands', lat: -9.4333, lon: 159.9500, population: 84520 },
                          { name: 'Port Moresby', country: 'Papua New Guinea', lat: -9.4438, lon: 147.1803, population: 364125 },
                          { name: 'Dili', country: 'Timor-Leste', lat: -8.5586, lon: 125.5736, population: 222323 },
                          { name: 'Bandar Seri Begawan', country: 'Brunei', lat: 4.9031, lon: 114.9398, population: 100700 },
                          { name: 'Funafuti', country: 'Tuvalu', lat: -8.5243, lon: 179.1942, population: 6320 },
                          { name: 'Tarawa Sud', country: 'Kiribati', lat: 1.3283, lon: 172.9748, population: 63439 },
                          { name: 'Majuro', country: 'Marshall Islands', lat: 7.1147, lon: 171.3781, population: 20464 },
                          { name: 'Palikir', country: 'Micronesia', lat: 6.9177, lon: 158.1611, population: 6645 },
                          { name: 'Ngerulmud', country: 'Palau', lat: 7.5005, lon: 134.6242, population: 271 },
                          { name: 'Yaren', country: 'Nauru', lat: -0.5477, lon: 166.9209, population: 747 },
                          { name: 'Città del Vaticano', country: 'Vatican City', lat: 41.9029, lon: 12.4534, population: 825 },
                          { name: 'Monaco', country: 'Monaco', lat: 43.7384, lon: 7.4246, population: 38300 },
                          { name: 'San Marino', country: 'San Marino', lat: 43.9424, lon: 12.4578, population: 4211 },
                          { name: 'Vaduz', country: 'Liechtenstein', lat: 47.1410, lon: 9.5215, population: 5696 },
                          { name: 'Andorra la Vella', country: 'Andorra', lat: 42.5063, lon: 1.5218, population: 22256 },
                          { name: 'Lomé', country: 'Togo', lat: 6.1375, lon: 1.2222, population: 837437 },
                          { name: 'Porto-Novo', country: 'Benin', lat: 6.4969, lon: 2.6036, population: 264320 },
                          { name: 'Tripoli', country: 'Libya', lat: 32.8872, lon: 13.1913, population: 1150000 },
                          { name: 'Gitega', country: 'Burundi', lat: -3.4283, lon: 29.9250, population: 41944 },
                          { name: 'Dodoma', country: 'Tanzania', lat: -6.1630, lon: 35.7516, population: 410956 },
                          { name: 'Sri Jayawardenepura Kotte', country: 'Sri Lanka', lat: 6.9022, lon: 79.9189, population: 115826 }
        ];

        // --- Funzione Principale di Inizializzazione ---
        function init() {
            // Scena e Camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.01, 1000);
            camera.position.set(0, 0, 3.5);
            cameraTargetPos.copy(camera.position);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Luci
            scene.add(new THREE.AmbientLight(0xcccccc, 1.0));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(5, 3, 5);
            scene.add(dirLight);

            raycaster = new THREE.Raycaster();
            raycaster.params.Line.threshold = 0.01; // Aumenta la tolleranza per il click sui bordi

            // Creazione del mondo 3D
            globe = new THREE.Group();
            scene.add(globe);

            createGlobeSurface();
            loadFontAndData();
            
            // UI
            create2DMap();
            createCapitalTabs();
            setupEventListeners();
            
            // Avvio del loop di animazione
            animate();
        }

        function createGlobeSurface() {
            const geometry = new THREE.SphereGeometry(GLOBE_RADIUS, 64, 64);
            const material = new THREE.MeshPhongMaterial({
                color: 0x08102a, // Blu scuro per gli oceani
                shininess: 5
            });
            const sphere = new THREE.Mesh(geometry, material);
            globe.add(sphere);
        }
        
        function loadFontAndData() {
            const fontLoader = new THREE.FontLoader();
            fontLoader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', (font) => {
                threeFont = font;
                addCapitals(); // Aggiungi le capitali solo dopo aver caricato il font
                createGraticule(); // <-- AGGIUNGI QUESTA RIGA QUI
            });
            loadCountries(); // Carica i paesi in parallelo
        }
        
        function addCapitals() {
            const capitalGroup = new THREE.Group();
            capitals.forEach(capital => {
                const capitalPos = latLonToVector3(capital.lat, capital.lon, GLOBE_RADIUS + 0.002);
                
                // Punto sulla superficie (dimensione basata sulla popolazione)
                const pointSize = 0.003 + Math.log10(capital.population) * 0.0015;
                const pointGeo = new THREE.SphereGeometry(pointSize, 16, 16);
                const pointMat = new THREE.MeshBasicMaterial({ color: 0xffe86e });
                const pointMesh = new THREE.Mesh(pointGeo, pointMat);
                pointMesh.position.copy(capitalPos);
                capital.mesh = pointMesh;
                capitalGroup.add(pointMesh);

                // Linea perpendicolare
                const lineEndPoint = capitalPos.clone().multiplyScalar(1.15);
                const lineGeo = new THREE.BufferGeometry().setFromPoints([capitalPos, lineEndPoint]);
                const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 });
                capitalGroup.add(new THREE.Line(lineGeo, lineMat));
                
                // Testo 3D
                const textGeo = new THREE.TextGeometry(capital.name, {
                    font: threeFont, size: 0.015, height: 0.001,
                });
                textGeo.center();
                const textMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const textMesh = new THREE.Mesh(textGeo, textMat);
                textMesh.position.copy(lineEndPoint);
                textMesh.lookAt(camera.position); // Inizialmente guarda la camera
                capital.textMesh = textMesh;
                capitalGroup.add(textMesh);
            });
            globe.add(capitalGroup);
        }

        function loadCountries() {
            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(res => res.json())
                .then(geoJson => {
                    geoJson.features.forEach(feature => {
                        if (!feature.geometry) return;

                        const countryName = feature.properties.name;
                        const countryGroup = new THREE.Group();
                        countryGroup.userData.countryName = countryName;

                        const shapes = createShapesFromCoords(feature.geometry.coordinates);
                        
                        // Bordo visibile e cliccabile
                        shapes.forEach(shape => {
                            const points = shape.getPoints();
                            const borderPoints3D = points.map(p => latLonToVector3(p.y, p.x, GLOBE_RADIUS + 0.005));
                            
                            const lineGeo = new THREE.BufferGeometry().setFromPoints(borderPoints3D);
                            const lineMat = new THREE.LineBasicMaterial({ color: 0x87ceeb, linewidth: 2 }); // Spessore non supportato da tutti i driver
                            const line = new THREE.Line(lineGeo, lineMat);
                            line.userData.countryName = countryName; // Riferimento per il raycasting
                            countryGroup.add(line);
                        });
                        
                        countryObjects.push(countryGroup);
                        globe.add(countryGroup);
                    });
                });
        }
        
        function latLonToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 90) * (Math.PI / 180);
            const x = -radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.cos(phi);
            const z = radius * Math.sin(phi) * Math.sin(theta);
            return new THREE.Vector3(x, y, z);
        }
        
        
        function createShapesFromCoords(coords) {
            const shapes = [];
            if (!coords) return shapes;
            coords.forEach(polygon => {
                const shape = new THREE.Shape();
                // Assicurati che il poligono sia un array di punti
                const path = Array.isArray(polygon[0][0]) ? polygon[0] : polygon;
                path.forEach((p, i) => {
                    if (i === 0) shape.moveTo(p[0], p[1]);
                    else shape.lineTo(p[0], p[1]);
                });
                shapes.push(shape);
            });
            return shapes;
        }

        // --- Logica di Interazione e Selezione ---
        function onMouseClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const countryMeshes = countryObjects.flatMap(c => c.children);
            const intersects = raycaster.intersectObjects(countryMeshes);

            if (intersects.length > 0) {
                const countryName = intersects[0].object.userData.countryName;
                selectCountry(countryName);
            } else {
                deselectCountry();
            }
        }
        
        function selectCountry(countryName) {
            // Se clicco di nuovo sullo stesso paese, non faccio nulla
            if (selectedCountry && selectedCountry.name === countryName) return;

            // Gestisco la deselezione del paese precedente (resetto il colore del bordo)
            if (selectedCountry) {
                selectedCountry.group.children.forEach(line => {
                    if (line.material) {
                        line.material.color.set(0x87ceeb);
                    }
                });
            }

            const country = countryObjects.find(c => c.userData.countryName === countryName);
            if (!country) return;

            // Imposto il nuovo paese come selezionato
            selectedCountry = { group: country, name: countryName };
            
            // Aggiorno le UI
            updateCountryInfo(countryName);
            update2DMap(countryName);

            // --- LOGICA DI DISEGNO ROTTA (CORRETTA) ---
            const capital = capitals.find(c => c.country === countryName);
            if (capital) {
                // Se esiste già una capitale di partenza (e non è la stessa che ho appena cliccato)
                if (routeStartCapital && routeStartCapital.name !== capital.name) {
                    drawOrthodromicRoute(routeStartCapital, capital); // Disegno la rotta
                    routeStartCapital.mesh.material.color.set(0xffe86e); // Reset colore partenza
                    routeStartCapital = null; // Pulisco la partenza per il prossimo giro
                } else {
                    // Altrimenti, questa diventa la mia nuova capitale di partenza
                    removeOrthodromicRoute(); // Pulisco eventuali rotte precedenti
                    if (routeStartCapital) routeStartCapital.mesh.material.color.set(0xffe86e); // Pulisco il colore
                    
                    routeStartCapital = capital;
                    capital.mesh.material.color.set(0xffa500); // Evidenzio la partenza in arancione
                }
                flyToCapital(capital); // Muovo la camera
            }
        }
        
        function deselectCountry() {
            // Resetta il colore del bordo del paese precedentemente selezionato
            if (selectedCountry) {
                selectedCountry.group.children.forEach(line => {
                    if (line.material) {
                        line.material.color.set(0x87ceeb);
                    }
                });
            }
            selectedCountry = null;

            // Nasconde i pannelli UI
            document.getElementById('country-info').style.display = 'none';
            update2DMap(null);

            // Rimuove la rotta e resetta la selezione della partenza
            removeOrthodromicRoute();
            if (routeStartCapital) {
                routeStartCapital.mesh.material.color.set(0xffe86e); // Reset colore
                routeStartCapital = null;
            }
        }

        function flyToCapital(capital) {
            const capitalPos = latLonToVector3(capital.lat, capital.lon, GLOBE_RADIUS);
            cameraTargetPos.copy(capitalPos.clone().multiplyScalar(2.0)); // Vista a volo d'uccello
            isCameraMoving = true;
        }
        
        /**
         * Disegna un TUBO 3D (rotta ortodromica) tra due capitali.
         * @param {object} startCap - Oggetto della capitale di partenza.
         * @param {object} endCap - Oggetto della capitale di arrivo.
         */
        function drawOrthodromicRoute(startCap, endCap) {
            removeOrthodromicRoute(); // Rimuovi la rotta precedente, se esiste

            const startVec = startCap.mesh.position;
            const endVec = endCap.mesh.position;

            // Calcola il punto di controllo per la curva, più alto per un arco evidente
            const controlPoint = new THREE.Vector3()
                .addVectors(startVec, endVec)
                .multiplyScalar(0.5)
                .normalize()
                .multiplyScalar(GLOBE_RADIUS * 1.3);

            // Crea la curva 3D
            const curve = new THREE.QuadraticBezierCurve3(startVec, controlPoint, endVec);

            // --- CREAZIONE DEL TUBO ---
            // Invece di una linea, creiamo una geometria a tubo lungo la curva
            const tubeGeometry = new THREE.TubeGeometry(
                curve,      // Percorso
                64,         // Segmenti lungo la curva (fluidità)
                0.005,      // Raggio del tubo (spessore)
                8,          // Segmenti radiali (rotondità)
                false       // Non è una curva chiusa
            );

            // Usiamo un materiale luminoso (MeshBasicMaterial non è affetto da luci)
            const tubeMaterial = new THREE.MeshBasicMaterial({
                color: 0xffa500 // Arancione brillante
            });

            // Crea l'oggetto 3D del tubo, lo salva e lo aggiunge al globo
            routeLine = new THREE.Mesh(tubeGeometry, tubeMaterial);
            globe.add(routeLine);
        }

        /**
         * Rimuove il tubo della rotta dalla scena, se presente.
         */
        function removeOrthodromicRoute() {
            if (routeLine) {
                globe.remove(routeLine);
                routeLine.geometry.dispose(); // Pulisce la memoria
                routeLine.material.dispose(); // Pulisce la memoria
                routeLine = null;
            }
        }

        // --- Aggiornamento UI ---
        function updateCountryInfo(countryName) {
            const infoBox = document.getElementById('country-info');
            document.getElementById('country-name').textContent = countryName;
            
            const capital = capitals.find(c => c.country === countryName);
            document.getElementById('capital-name').textContent = capital ? `Capitale: ${capital.name}` : 'Capitale: N/D';
            
            infoBox.style.display = 'block';
        }

        function createCapitalTabs() {
            const tabsContainer = document.getElementById('capital-tabs');
            capitals.forEach(capital => {
                const button = document.createElement('button');
                button.textContent = capital.name;
                button.onclick = () => {
                    selectCountry(capital.country);
                };
                tabsContainer.appendChild(button);
            });
        }
        
        let d3Projection, d3Path, d3Svg;
        function create2DMap() {
            const width = 300, height = 180;
            d3Svg = d3.select("#map-2d");
            d3Projection = d3.geoMercator().fitSize([width, height], {type: "Sphere"});
            d3Path = d3.geoPath().projection(d3Projection);

            d3.json('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json').then(data => {
                d3Svg.selectAll("path")
                    .data(data.features)
                    .enter().append("path")
                    .attr("d", d3Path)
                    .attr("fill", "rgba(127, 178, 255, 0.1)")
                    .attr("stroke", "rgba(127, 178, 255, 0.5)")
                    .attr("stroke-width", 0.5)
                    .attr("data-country-name", d => d.properties.name);
            });
        }
        
        function update2DMap(selectedCountryName) {
            d3Svg.selectAll("path").attr("fill", "rgba(127, 178, 255, 0.1)");
            if (selectedCountryName) {
                d3Svg.selectAll("path")
                    .filter(d => d.properties.name === selectedCountryName)
                    .attr("fill", "#7fbbff");
            }
        }

        // --- Controlli e Eventi ---
        function setupEventListeners() {
            let isDragging = false, prevMouse = { x: 0, y: 0 };
            container.addEventListener('mousedown', e => {
                isDragging = true;
                container.style.cursor = 'grabbing';
                prevMouse = { x: e.clientX, y: e.clientY };
            });
            container.addEventListener('mouseup', (e) => {
                const dx = e.clientX - prevMouse.x;
                const dy = e.clientY - prevMouse.y;
                if (Math.hypot(dx, dy) < 5) { // Se non c'è stato trascinamento, è un click
                    onMouseClick(e);
                }
                isDragging = false;
                container.style.cursor = 'grab';
            });
            container.addEventListener('mouseleave', () => { isDragging = false; container.style.cursor = 'grab'; });
            container.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const delta = { x: e.clientX - prevMouse.x, y: e.clientY - prevMouse.y };
                globe.rotation.y += delta.x * 0.005;
                globe.rotation.x += delta.y * 0.005;
                prevMouse = { x: e.clientX, y: e.clientY };
            });
            container.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY * 0.005); });
            window.addEventListener('resize', onWindowResize);
            document.getElementById('zoom-in').addEventListener('click', () => zoom(-0.5));
            document.getElementById('zoom-out').addEventListener('click', () => zoom(0.5));
        }

        function zoom(amount) {
            const newZ = camera.position.length() + amount;
            if (newZ >= 1.5 && newZ <= 10) {
                 camera.position.setLength(newZ);
                 cameraTargetPos.copy(camera.position);
            }
        }

        function onWindowResize() {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        /**
         * Crea e aggiunge al globo una griglia di meridiani e paralleli (reticolato).
         * Include etichette 3D per le coordinate lungo l'Equatore e il Meridiano di Greenwich.
         * La funzione si aspetta che la variabile 'threeFont' sia già stata caricata.
         */
        function createGraticule() {
            if (!threeFont) {
                console.error("Il font non è stato caricato. Impossibile creare le etichette del reticolato.");
                return;
            }

            const graticuleGroup = new THREE.Group();
            const graticuleMaterial = new THREE.LineBasicMaterial({
                color: 0x00ff00, // Colore lime, come richiesto
                transparent: true,
                opacity: 0.25 // Opacità bassa
            });

            const textMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ff00, // Stesso colore per coerenza
                side: THREE.DoubleSide
            });

            // Helper per creare testo 3D
            const createTextLabel = (text, position) => {
                const textGeo = new THREE.TextGeometry(text, {
                    font: threeFont,
                    size: 0.012,
                    height: 0.001,
                });
                textGeo.center();
                const textMesh = new THREE.Mesh(textGeo, textMaterial);
                textMesh.position.copy(position);
                // Orienta il testo in modo che "guardi" verso l'esterno, perpendicolare alla superficie
                textMesh.lookAt(position.clone().multiplyScalar(2));
                return textMesh;
            };

            // --- Disegna Meridiani e Paralleli ---
            const step = 15; // Disegna una linea ogni 15 gradi
            for (let i = -180; i <= 180; i += step) {
                // Meridiani (longitudine)
                const pointsLon = [];
                for (let lat = -90; lat <= 90; lat++) {
                    pointsLon.push(latLonToVector3(lat, i, GLOBE_RADIUS + 0.001));
                }
                const geometryLon = new THREE.BufferGeometry().setFromPoints(pointsLon);
                graticuleGroup.add(new THREE.Line(geometryLon, graticuleMaterial));

                // Etichette sull'Equatore (ogni 30 gradi per non affollare)
                if (i % 30 === 0 && i !== 180 && i !== -180) {
                    const labelText = i === 0 ? "0°" : `${Math.abs(i)}°${i < 0 ? 'W' : 'E'}`;
                    const labelPos = latLonToVector3(0, i, GLOBE_RADIUS * 1.03); // Posiziona leggermente sopra
                    graticuleGroup.add(createTextLabel(labelText, labelPos));
                }
            }

            for (let i = -90; i <= 90; i += step) {
                // Paralleli (latitudine)
                const pointsLat = [];
                for (let lon = -180; lon <= 180; lon++) {
                    pointsLat.push(latLonToVector3(i, lon, GLOBE_RADIUS + 0.001));
                }
                const geometryLat = new THREE.BufferGeometry().setFromPoints(pointsLat);
                graticuleGroup.add(new THREE.Line(geometryLat, graticuleMaterial));
                
                // Etichette sul Meridiano di Greenwich (ogni 30 gradi)
                if (i % 30 === 0 && i !== 0 && i !== 90 && i !== -90) {
                    const labelText = `${Math.abs(i)}°${i < 0 ? 'S' : 'N'}`;
                    const labelPos = latLonToVector3(i, 0, GLOBE_RADIUS * 1.03);
                    graticuleGroup.add(createTextLabel(labelText, labelPos));
                }
            }

            globe.add(graticuleGroup);
        }

        // --- Loop di Animazione ---
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.005;

            // Animazione pulsante del bordo selezionato
            if (selectedCountry) {
                const pulse = 0.7 + Math.sin(time * 2) * 0.3; // Valore tra 0.4 e 1.0
                const color = new THREE.Color(0.8, 1.0, 1.0).multiplyScalar(pulse);
                selectedCountry.group.children.forEach(line => {
                    line.material.color.set(color);
                });
            }
            
            // Animazione pulsante delle capitali
            capitals.forEach(c => {
                if(c.mesh) {
                    const scale = 1.0 + Math.sin(time + c.lat) * 0.4;
                    c.mesh.scale.set(scale, scale, scale);
                }
                // Orienta sempre il testo verso la camera
                if (c.textMesh) {
                    c.textMesh.lookAt(camera.position);
                }
            });

            // Animazione camera (interpolazione)
            if (isCameraMoving) {
                camera.position.lerp(cameraTargetPos, 0.05);
                if (camera.position.distanceTo(cameraTargetPos) < 0.01) {
                    camera.position.copy(cameraTargetPos);
                    isCameraMoving = false;
                }
            }
            camera.lookAt(scene.position);

            renderer.render(scene, camera);
        }
        
        // --- Avvio ---
        init();
    });
    </script>
</body>
</html>
